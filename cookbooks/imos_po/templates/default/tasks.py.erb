#!/usr/bin/python

from celery import Celery
import subprocess
from os import system

app = Celery('tasks')
app.config_from_object('<%= @celery_config.gsub(/.py$/, "") %>')

def watch_exec_wrapper(job_name, file_path, execute, execute_params):
    command = [
        "<%= node['imos_po']['watch_exec_wrapper'] %>",
        job_name,
        file_path,
        execute,
        execute_params
    ]
    print command
    subprocess.call(command)

<%
watchlists = Chef::Recipe::WatchJobs.get_watches(@watch_dir)
watchlists.each do |job_name, watchlist|
  watchlist['path'].each do |path|
    path = ::File.join(node['imos_po']['data_services']['incoming_dir'], path)
    execute = ::File.join(@data_services_dir, watchlist['execute'])
    execute_params = watchlist['execute_params']
%>
@app.task(ignore_result=True)
def <%= job_name %>(file_path):
    watch_exec_wrapper("<%= job_name %>", file_path, "<%= execute %>", "<%= execute_params %>")

<%
  end
end %>
