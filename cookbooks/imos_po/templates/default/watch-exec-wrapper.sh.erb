#!/bin/bash

source <%= @env %> || exit 255

# main
# example argument list:
# ACORN file.nc process-file.sh /home/netcdf
# $1 - file to run command with
# $2 - command to run
# "$@" - extra parameters for command
main() {
    declare -r JOB_NAME=$1; shift; export JOB_NAME
    declare -r INCOMING_FILE=$1; shift; export INCOMING_FILE
    local command=$1; shift
    local file=$INCOMING_FILE
    local file_basename=`basename $file`
    declare -r TRANSACTION_ID=`date +%Y%m%d-%H%M%S`; export TRANSACTION_ID

    if [ ! -f $file ]; then
        # not a file - ignore event
        return 0
    elif [ ${file_basename:0:1} == "." ]; then
        # file is hidden, usually a rsync file in progress
        return 0
    elif lsof $file >& /dev/null; then
        # file is still being accessed
        return 0
    fi

    # make file read only before giving it to incoming handlers
    sudo chmod 00444 $file && sudo chown <% @user %>:<%= @group %> $file || \
        file_error "Error setting permissions"

    eval $command $file "$@" 2>&1 | log_out

    # make sure file was handled, move to error directory if not
    if [ -f $file ]; then
        file_error "Not moved out of incoming directory"
    fi
}

main "$@"
