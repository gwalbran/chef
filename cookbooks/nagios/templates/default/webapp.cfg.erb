# Apache definitions
#
# Autogenerated by Chef.

<%
tomcat_ports = []
@nodes.each do |n|
  host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]

  # perform a search on web apps
  if n['webapps'] and n['webapps']['instances']
    n['webapps']['instances'].each do |webapp_instance|
      tomcat_name     = webapp_instance['name']
      app_vhost       = webapp_instance['vhost']
      app_tomcat_port = webapp_instance['port']
%>
define service {
  service_description <%= tomcat_name %> tomcat <%= app_tomcat_port %>
  check_command check_tomcat_<%= app_tomcat_port %>
  host_name <%= host_name %>
  servicegroups tomcat
  use default-service-pnp
<% if webapp_instance['nagios_restart_handler'] %>
  event_handler restart_tomcat_<%= app_tomcat_port %>
<% end %>
}

define service {
  service_description <%= tomcat_name %> jmx heap mem usage <%= app_tomcat_port %>
  check_command check_jmx_heap_mem_usage_<%= app_tomcat_port %>
  host_name <%= host_name %>
  servicegroups tomcat
  use default-service-pnp
}


<%
      # collect all ports, so we can define commands
      tomcat_ports.push(app_tomcat_port)

      # monitor every defined application
      monitored_links = []

      webapp_instance['apps'].each do |app|
        monitored_links << {'url' => app['name']}
        if app['aliases']
          app['aliases'].each do |_alias|
            monitored_links << {'url' => _alias}
          end
        end

        if app['monitored_urls']
          monitored_links += app['monitored_urls']
        end
      end

      monitored_links.each do |monitored_link|
        monitored_url = monitored_link['url']
        monitor_name  = monitored_link['name']

        # allow unset monitor names
        if !monitor_name || monitor_name == ""
          monitor_name = monitored_url
        end
%>

define service {
  service_description <%= monitor_name %> apache <%= app_vhost %>:80/<% monitored_url[0..15] %>
  check_command check_http!<%= app_vhost %>!80!/<%= monitored_url %>!
  host_name <%= host_name %>
  use default-service-pnp
  servicegroups http
}
<%
      end

    end
  end
end
%>

<% tomcat_ports.uniq.each do |tomcat_port| -%>
define command {
        command_name    check_tomcat_<%= tomcat_port %>
        command_line    $USER1$/check_nrpe -H $HOSTADDRESS$ -c check_tomcat_<%= tomcat_port %> -t 20
}

define command {
        command_name    check_jmx_heap_mem_usage_<%= tomcat_port %>
        command_line    $USER1$/check_nrpe -H $HOSTADDRESS$ -c check_jmx_heap_mem_usage_<%= tomcat_port %> -t 20
}

define command {
        command_name    restart_tomcat_<%= tomcat_port %>
        command_line    $USER1$/run_if_critical_hard $SERVICESTATE$ $SERVICESTATETYPE$ $SERVICEATTEMPT$ $USER1$/check_nrpe -H $HOSTADDRESS$ -c restart_tomcat_<%= tomcat_port %> -t 20
}
<% end -%>
