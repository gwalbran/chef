# Apache definitions
#
# Autogenerated by Chef.

<% current_host_name = node['nagios']['server']['normalize_hostname'] ? node[node['nagios']['host_name_attribute']].downcase : node[node['nagios']['host_name_attribute']] -%>
<%
talend_jobs = []
@nodes.uniq.each do |n|
  host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]

  talend_jobs_ignore = []
  if n['nagios'] && n['nagios']['talend'] && n['nagios']['talend']['jobs_ignore']
    talend_jobs_ignore = n['nagios']['talend']['jobs_ignore']
  end

  if n['run_list'].include?("recipe[talend]") && n['talend'] && n['talend']['jobs']
    n['talend']['jobs'].each do |talend_job|
      if ! talend_jobs_ignore.include?(talend_job)
%>
define service {
  service_description talend <%= talend_job %>
  host_name <%= host_name %>
  check_command check_talend_<%= talend_job %>
  servicegroups talend
  use default-service
}
<%
        talend_jobs.push(talend_job)
      end
    end
  end
end
%>

<% talend_jobs.uniq.each do |talend_job| -%>
define command {
        command_name    check_talend_<%= talend_job %>
        command_line    $USER1$/check_nrpe -H $HOSTADDRESS$ -c check_talend_<%= talend_job %> -t 20
}
<% end -%>
