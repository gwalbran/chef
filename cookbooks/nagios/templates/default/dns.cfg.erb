# Apache definitions
#
# Autogenerated by Chef.

<%
@nodes.each do |n|
host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]
  if host_name and n['network'] and n['network']['public_ipv4']
    fqdn      = host_name
    ipaddress = n['network']['public_ipv4']

    # Check A records
    if n['fqdn'] %>
define service {
  service_description dns A <%= fqdn %> <%= ipaddress %>
  check_command check_dig!A!<%= fqdn %>!<%= ipaddress %>
  host_name <%= host_name %>
  servicegroups dns
  use service-dns
}
<%  end

    # Check all aliases
    if n['aliases']
      n['aliases'].each do |_alias|
%>
define service {
  service_description dns CNAME <%= _alias %> <%= fqdn %>
  check_command check_dig!CNAME!<%= _alias %>!<%= fqdn %>
  host_name <%= host_name %>
  servicegroups dns
  use service-dns
}
<%
      end
    end
  end
end
%>

<%
# Handle DNS on unmanaged hosts
@unmanaged_hosts.each do |n|
  host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]
  if n['address']
    fqdn      = host_name
    ipaddress = n['address']
%>
define service {
  service_description dns A <%= fqdn %> <%= ipaddress %>
  check_command check_dig!A!<%= fqdn %>!<%= ipaddress %>
  host_name <%= host_name %>
  servicegroups dns
  use service-dns
}
<%
  end
end
%>

# Pseudo host for unmanaged DNS records, just a host to attach the checks to...
define host {
  use server
  address 127.0.0.1
  host_name unmanaged-dns-pseudo-host
  hostgroups all
}

<%
# Handle unmanaged DNS records
@dns.each do |dns_domain|
  if dns_domain['records']
    dns_domain['records'].each do |dns_record|
      type  = dns_record[0]
      key   = dns_record[1]
      value = dns_record[2]
      if type == "CNAME"
%>
define service {
  service_description dns <%= type %> <%= key %> <%= value %>
  check_command check_dig!<%= type %>!<%= key %>!<%= value %>
  host_name unmanaged-dns-pseudo-host
  servicegroups dns
  use service-dns
}
<%
      end
    end
  end
end
%>
