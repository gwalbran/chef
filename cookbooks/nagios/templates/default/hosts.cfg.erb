# Host definitions
#
# Autogenerated by Chef.

<% current_host_name = node['nagios']['server']['normalize_hostname'] ? node[node['nagios']['host_name_attribute']].downcase : node[node['nagios']['host_name_attribute']] -%>
<%# handle the nagios node differently than others to prevent failures in bootstrap scenarios %>
define host {
  use server
  address <%= node['ipaddress'] %>
  host_name <%= current_host_name %>
  hostgroups <% if node['nagios']['multi_environment_monitoring'] -%><%= node.chef_environment %>,<% end -%>all,<%= node['roles'].join(",") %><% if !node['roles'].include?(node['nagios']['server_role']) %>,<%= node['nagios']['server_role'] %><% end -%>
}

<% @nodes.each do |n| -%>
<% host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']] %>
<% unless host_name == current_host_name -%>
define host {
  <%
  ip = ""
  if n['network'] && n['network']['public_ipv4']
    ip = n['network']['public_ipv4']
  else
    Chef::Application.fatal!("Node '#{n['fqdn']}' does not have a network/public_ipv4 address!")
  end %>
  use server
  address <%= ip %>
  host_name <%= host_name %>

  <% if node['nagios']['multi_environment_monitoring'] -%>
  <% if n['roles'].nil? || n['roles'].length == 0 -%>
  hostgroups all,<%= n.os %>, <%= n.chef_environment %>
  <% else -%>
  hostgroups all,<%= (n['roles'] & @hostgroups).join(",") %>,<%= n.os %>, <%= n.chef_environment %>
  <% end -%>
  <% elsif -%>
  <% if n['roles'].nil? || n['roles'].length == 0 -%>
  hostgroups all,<%= n.os %>
  <% else -%>
  hostgroups all,<%= (n['roles'] & @hostgroups).join(",") %>,<%= n['os'] %>
  <% end -%>
  <% end -%>
}
<% end -%>
<% end -%>

<% unless @unmanaged_hosts.nil? -%>
<% @unmanaged_hosts.each do |n| -%>
define host {
  use server
  address <%= n['address'] %>
  host_name <%= node['nagios']['server']['normalize_hostname'] ? n['fqdn'].downcase : n['fqdn'] %>
  hostgroups all,<%= n['hostgroups'].join(",") %>
  notifications_enabled <%= n['notifications'] %>
}
<% end -%>
<% end -%>
