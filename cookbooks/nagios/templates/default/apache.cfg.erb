# Apache definitions
#
# Autogenerated by Chef.

<%
@nodes.each do |n|
host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]
  # perform a search on httpd hosts
  if n['apache'] && n['apache']['vhosts']
    n['apache']['vhosts'].each do |apache_vhost|
      vhost_name = apache_vhost['name']

      vhost_port = apache_vhost['https'] ? 443 : 80
      if apache_vhost['port']
        vhost_port = apache_vhost['port']
      end

      # add --ssl if this is running https
      vhost_extra_options = vhost_port == 80 ? "" : "--ssl"

      vhost_uris = []

      if apache_vhost['nagios_checks']
        apache_vhost['nagios_checks'].each do |nagios_check|
          vhost_uris << nagios_check['uri']
        end
      else
        # use the default "/" anyway
        vhost_uris.push("/")
        # iterate on all vhost redirects
        if apache_vhost['httpd_redirects']
          apache_vhost['httpd_redirects'].each do |httpd_redirect|
            vhost_uris.push("/" + httpd_redirect['to'])
          end
        end
      end

      vhost_uris.uniq.each do |vhost_uri|
%>
define service {
  service_description apache vhost <%= vhost_name %>:<%= vhost_port %><%= vhost_uri %>
  check_command check_http!<%= vhost_name %>!<%= vhost_port %>!<%= vhost_uri %>!<%= vhost_extra_options %>
  host_name <%= host_name %>
  servicegroups apache
  use default-service
}
<%
      end

    end
  end
end
%>

<%
# Handle websites on unmanaged hosts
@unmanaged_hosts.each do |n|
  host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]
  if n['websites']
    n['websites'].each do |website|
      vhost_name = website['name']
      vhost_port = website['port'] ? website['port'] : 80
      vhost_uri  = website['uri'] ? website['uri'] : "/"
      # notice we'll truncate vhost_uri when creating the service description
      # as it can get rather long sometimes...
%>
define service {
  service_description apache vhost <%= vhost_name %>:<%= vhost_port %><%= vhost_uri[0..9] %>
  check_command check_http!<%= vhost_name %>!<%= vhost_port %>!<%= vhost_uri %>
  host_name <%= host_name %>
  servicegroups apache
  use default-service
}
<%
    end
  end
end
%>
