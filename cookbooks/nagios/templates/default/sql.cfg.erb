# Apache definitions
#
# Autogenerated by Chef.

<%
# Handle SQL queries on managed hosts
@nodes.each do |n|
  host_name = node['nagios']['server']['normalize_hostname'] ? n[node['nagios']['host_name_attribute']].downcase : n[node['nagios']['host_name_attribute']]

  # perform a search on sql data bags
  if n['nagios'] and n['nagios']['sql']
    n['nagios']['sql'].each do |sql_data_bag_name|
      sql_data_bag = Chef::DataBagItem.load("nagios_sql", sql_data_bag_name)
      sql_data_bag['monitors'].each do |sql_object|
        fqdn      = host_name
        name      = sql_object['name']
        # escape semi colons, nagios doesn't like it...
        dbi       = sql_object['dbi'].gsub(";", "\\;")
        username  = sql_object['username'] ? sql_object['username'] : node['nagios']['server']['sql_username']
        password  = sql_object['password'] ? sql_object['password'] : node['nagios']['server']['sql_password']
        query     = sql_object['query']
        expect    = sql_object['expect']
%>
define service {
  service_description <%= name %>
  check_command check_sql!"<%= dbi %>"!"<%= username %>"!"<%= password %>"!"<%= expect %>"!"<%= query %>"
  host_name <%= host_name %>
  servicegroups sql
  use default-service
}
<%
      end
    end
  end
end
%>

