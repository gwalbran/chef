#
# Copyright (C) 2013 Dan Fruehauf <malkodan@gmail.com>
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.
#

#
# Autogenerated by Chef.
#

<%
backup_name = @backup_name
backup_dir  = node[:backup][:backup_dir]
%>

log() {
    logfile <%= node[:backup][:log_dir] %>/<%= @backup_name %>.log
}

backup() {
<%
excludes = ""
if @params[:files_exclude]
  excludes = "--exclude='" + @params[:files_exclude].join("' --exclude='") + "'"
end

files = @params[:files].join(" ")

backup_string = "tar #{@backup_name} --sudo #{files} #{excludes}"

%>
    <%= backup_string %>
<%

if @params[:databases]
  @params[:databases].each do |database|
  # Extract database parameters
  db_host               = database['host']
  db_port               = database['port']
  db_name               = database['name']
  db_username           = database['username']
  db_password           = database['password']

  # Form the backup string
  backup_string = "imos_pgsql #{backup_name}.#{db_name} '#{db_host}:#{db_port}:#{db_name}:#{db_username}:#{db_password}'"
%>
    <%= backup_string %>
<%
  end
end
%>
}

process() {
    gzip '.*'
}

store() {
<% if node[:imos_backup][:s3][:enable] && ! node[:imos_backup][:restore][:allow]
     s3cfg = node[:imos_backup][:s3][:config_file]
     s3path = ::File.join(node[:imos_backup][:s3][:bucket], node[:imos_backup][:s3][:path], node['fqdn'], @backup_name)
     # Keep as many backups as a server would
     backups_to_keep = node[:imos_backup][:server][:backups_to_keep]
%>
    s3 <%= s3path %> --config=<%= s3cfg %>
    s3_cycle <%= s3path %> <%= backups_to_keep %> --config=<%= s3cfg %>
<% else %>
    mv <%= ::File.join(node[:backup][:backup_dir], @backup_name) %>
    cycle <%= ::File.join(node[:backup][:backup_dir], @backup_name) %> <%= node[:backup][:backups_to_keep] %>
<% end %>
}

notify() {
    nagios_status "<%= node[:imos_backup][:status_dir] %>"
}
