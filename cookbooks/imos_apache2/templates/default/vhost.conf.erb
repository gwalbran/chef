<%
# Logs
error_log     = File.join(node['apache']['log_dir'], "#{@params[:name]}-error.log")
rewrite_log   = File.join(node['apache']['log_dir'], "#{@params[:name]}-rewrite.log")
# Have the same access log for both http and https hosts, so use the vhost which
# will not include the '_ssl' suffix, so awstats and friends can parse it
access_log    = File.join(node['apache']['log_dir'], "#{@params[:vhost]}-access.log")

if @params[:https]
  protocol = "https"
  port     = 443
else
  protocol = "http"
  port     = 80
end
%>

# HTTP vhost
<VirtualHost *:<%= port %>>
<% if @params[:server_admin] %>
  ServerAdmin <%= @params[:server_admin] %>
<% end %>
  ServerName <%= @params[:vhost] %>
<% if @params[:server_aliases] %>
  ServerAlias <% @params[:server_aliases].each do |a| %><%= "#{a}" %> <% end %>
<% end %>

<% if @params[:docroot] %>
  DocumentRoot <%= @params[:docroot] %>

  <Directory <%= @params[:docroot] %>>
    DirectoryIndex <%= @params[:directory_index] %>
    Options +Indexes +FollowSymLinks
    AllowOverride None
    Order allow,deny
    Allow from all
  </Directory>
<% end %>

<% if @params[:content_repo] %>
  <Directorymatch "^/.*/\.git/">
    Order deny,allow
    Deny from all
  </Directorymatch>

  <FilesMatch "^README.md">
    Order allow,deny
    Deny from all
  </FilesMatch>
<% end %>

  TraceEnable off
  LogLevel info
  ErrorLog <%= error_log %>
  CustomLog <%= access_log %> combined

<% if @params[:httpd_redirects] %>
  # http redirects
  <% @params[:httpd_redirects].each do |redirect_pair|
       redirect_to = redirect_pair['to']
       redirect_from = redirect_pair['from']
  %>
  RewriteRule ^/<%= redirect_from %>$ http://<%= @params[:vhost] %>/<%= redirect_to %>
  <% end %>
<% end %>

<% if @params[:proxy_pass] %>
  # proxy and reverse proxy handling
  ProxyPreserveHost On

  # Enable proxying (disabled by default)
  <Proxy *>
    Order deny,allow
    Deny from all
    Allow from all
  </Proxy>

  <% @params[:proxy_pass].each do |proxy_pair|
       proxy_suffix = proxy_pair['from']
       proxy_port = proxy_pair['to_port']
  %>
  ProxyPass           /<%= proxy_suffix %>  http://localhost:<%= proxy_port %>/<%= proxy_suffix %>
  ProxyPassReverse    /<%= proxy_suffix %>  http://localhost:<%= proxy_port %>/<%= proxy_suffix %>
  <% end %>
<% end %>

  RewriteEngine On
  RewriteOptions inherit
  RewriteLog <%= rewrite_log %>
  RewriteLogLevel 0

<% if @params[:httpd_rules] %>
  <% @params[:httpd_rules].each do |rule| %>
  <%= rule %>
  <% end %>
<% end %>

<% if @params[:redirect_to_https] %>
  ReWriteCond %{SERVER_PORT} !^443$
  RewriteRule ^/(.*) https://%{HTTP_HOST}/$1 [NC,NE,R,L]
<% end %>

<% if protocol && protocol == "https" %>
  SSLEngine On
  SSLCertificateFile /etc/ssl/certs/<%= @params[:domain] %>.crt
  SSLCertificateKeyFile /etc/ssl/private/<%= @params[:domain] %>.key
  SSLCertificateChainFile /etc/ssl/certs/<%= @params[:domain] %>.chain.crt
<% end %>


</VirtualHost>
